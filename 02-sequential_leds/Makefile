#-------- MAKE FILE ------------#

# based on: https://electronics.stackexchange.com/a/66163
# more info in:
# 	- man 1 avr-objcopy
# 	- man 1 avr-objdump
# 	- man 1 avrdude

MCU=atmega328
MCU2=m328
F_CPU=16000000UL

CC=avr-gcc

CFLAGS=-g -std=c11 -mmcu=${MCU} -DF_CPU=${F_CPU} -I.\
       -Wall -Os -Wextra

OBJCOPY=avr-objcopy

OBJDUMP=avr-objdump

FLASHER=avrdude

PROGRAMMER=arduino

FFLAGS=-p ${MCU} -c ${PROGRAMMER} -b 57600 -F

PORT=/dev/ttyUSB0

SRC=main

help:
	@echo ''
	@echo 'preprocess output preprocessed ${SRC}.c'
	@echo 'object	create linked object file ${SRC}.o'
	@echo 'elf	create elf file ${SRC}.elf'
	@echo 'hex	create hex file ${SRC}.hex'
	@echo 'dump	create assembly file ${SRC}.asm'
	@echo 'fulldump	create labeled assembly file ${SRC}.asm'
	@echo 'all	create object, elf, hex and asm files'
	@echo 'flash	flash hex file to MCU flash memory'
	@echo 'clean	clean all files generated by make'
	@echo ''
	@echo 'edit	edit ${SRC}.c source code'
	@echo 'makefile edit Makefile'
	@echo 'help	display this message'
	@echo ''

edit:
	nvim ${SRC}.c

makefile:
	nvim Makefile

clean:
	@rm -f *.o *.hex *.elf *.i *.s *.asm
	@date
	@echo 'removed all .o .i .s .elf .hex .asm files'

preprocess:
	${CC} ${CFLAGS} -E -o ${SRC}.i ${SRC}.c

object:
	${CC} ${CFLAGS} -o ${SRC}.o ${SRC}.c

elf: object
	${OBJCOPY} -j .text -j .data -O binary ${SRC}.o ${SRC}.elf

hex: object
	${OBJCOPY} -j .text -j .data -O ihex ${SRC}.o ${SRC}.hex

dump:
	${CC} ${CFLAGS} -c -o ${SRC}.s ${SRC}.c
	${OBJDUMP} -m avr -S ${SRC}.s > ${SRC}.asm
	#${OBJDUMP} -m avr -d ${SRC}.s > ${SRC}.asm
	#@rm -f *.temp.s

fulldump:
	${CC} ${CFLAGS} -c -Wa,-ahlsm,-L -o ${SRC}.s ${SRC}.c
	${OBJDUMP} -m avr -d ${SRC}.s > ${SRC}.asm
	#@rm -f *.temp.s

all: elf hex dump

flash: hex
	${FLASHER} ${FFLAGS} -U flash:w:${SRC}.hex:i -P ${PORT}

