#-------- MAKE FILE ------------#

# based on: https://electronics.stackexchange.com/a/66163
# more info in: man 1 {avr-objcopy, avr-objdump, avrdude}

MCU=atmega328
MCU2=m328
F_CPU=16000000UL

INCLDIRS=. ./include/ ../include/
LIBSDIR=. ./libs/ ../libs/

CC=avr-gcc

DEBUG=-g	# debug flag
OPT=-Os		# optimize for size
DEPFLAGS=-MP -MD

CFLAGS=-std=c11 -Wall -Wextra ${OPT} \
       $(foreach D, $(INCLDIRS), -I$(D)) \
       -mmcu=${MCU} -DF_CPU=${F_CPU} \
       $(DEPFLAGS) ${DEBUG}

CFILES=$(foreach D, $(LIBSDIR), $(wildcard $(D)/*.c))
OBJS=$(patsubst %.c,%.o,$(CFILES))
DEPFILES=$(patsubst %.c,%.d,$(CFILES))

OBJCOPY=avr-objcopy

OBJDUMP=avr-objdump

PROG=arduino
PORT=/dev/ttyUSB0

FLASHER=avrdude

FFLAGS=-p ${MCU} -c ${PROG} -b 57600 -F

SRC=main

# $@ is the target
# $^ is the dependency
# $*.c evaluates to the current *.c file

all: ${SRC}.hex

flash: ${SRC}.hex
	${FLASHER} ${FFLAGS} -U flash:w:${SRC}.hex:i -P ${PORT}

%.hex: $(OBJS)
	${OBJCOPY} -j .text -j .data -O ihex $^ $@

%.elf: %.o
	${OBJCOPY} -j .text -j .data -O binary $^ $@

%.o: %.c
	${CC} ${CFLAGS} -o $@ $^

debug: ${SRC}.asm

%.asm: %.c
	${CC} ${CFLAGS} -c -o ${SRC}.s $^
	${OBJDUMP} -m avr -S ${SRC}.s > $@
	@rm $(SRC).s

fulldump:
	${CC} ${CFLAGS} -c -Wa,-ahlsm,-L -o ${SRC}.s ${SRC}.c
	${OBJDUMP} -m avr -d ${SRC}.s > ${SRC}.asm
	@rm $(SRC).s

clean:
	@rm -f $(DEPFILES) $(OBJS) *.hex *.elf *.asm
	@date
	@echo 'removed all .o .elf .hex .asm files'


help:
	@echo ''
	@echo 'preprocess output preprocessed ${SRC}.c'
	@echo 'object	create linked object file ${SRC}.o'
	@echo 'elf	create elf file ${SRC}.elf'
	@echo 'hex	create hex file ${SRC}.hex'
	@echo 'dump	create assembly file ${SRC}.asm'
	@echo 'fulldump	create labeled assembly file ${SRC}.asm'
	@echo 'all	create object, elf, hex and asm files'
	@echo 'flash	flash hex file to MCU flash memory'
	@echo 'clean	clean all files generated by make'
	@echo ''
	@echo 'edit	edit ${SRC}.c source code'
	@echo 'makefile edit Makefile'
	@echo 'help	display this message'
	@echo ''

env:
	echo "$(INCLDIRS)"
	echo "$(CFILES)"
	echo "$(OBJS)"
	echo "$(DEPFILES)"

-include $(DEPFILES)
